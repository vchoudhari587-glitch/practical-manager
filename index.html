<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Practical Manager</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0d1117; color: #e6edf3; font-family: sans-serif; min-height: 100vh; }

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #login-screen {
    display: flex; align-items: center; justify-content: center; min-height: 100vh;
  }
  .login-card {
    background: #161b22; border: 1px solid #30363d; border-radius: 12px;
    padding: 36px 32px; width: 360px; text-align: center;
  }
  .login-card .logo-icon { font-size: 36px; }
  .login-card h2 { font-size: 20px; margin: 10px 0 4px; }
  .login-card p { font-size: 13px; color: #8b949e; margin-bottom: 24px; }
  .login-card input {
    width: 100%; padding: 10px 14px; border-radius: 8px;
    border: 1px solid #30363d; background: #0d1117; color: #e6edf3;
    font-size: 14px; margin-bottom: 12px; outline: none;
  }
  .login-card input:focus { border-color: #2dd4bf; }
  .btn-login {
    width: 100%; padding: 10px; border-radius: 8px; border: none;
    background: #2dd4bf; color: #0d1117; font-size: 14px;
    font-weight: bold; cursor: pointer; margin-bottom: 10px;
  }
  .btn-login:hover { background: #5eead4; }
  .btn-guest {
    width: 100%; padding: 10px; border-radius: 8px;
    border: 1px solid #30363d; background: transparent;
    color: #8b949e; font-size: 13px; cursor: pointer;
  }
  .btn-guest:hover { color: #e6edf3; border-color: #8b949e; }
  .login-error { color: #f85149; font-size: 12px; margin-bottom: 10px; display: none; }

  /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
  #app { display: none; }

  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 28px; background: #161b22; border-bottom: 1px solid #30363d;
    position: sticky; top: 0; z-index: 10;
  }
  .logo { display: flex; align-items: center; gap: 8px; font-size: 17px; font-weight: bold; }
  .logo-icon { color: #2dd4bf; font-size: 22px; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .role-badge {
    font-size: 11px; padding: 3px 10px; border-radius: 20px; border: 1px solid; font-weight: 600;
  }
  .role-badge.admin { background: rgba(45,212,191,0.1); border-color: #2dd4bf; color: #2dd4bf; }
  .role-badge.guest { background: rgba(139,148,158,0.1); border-color: #8b949e; color: #8b949e; }
  .btn-logout {
    padding: 6px 14px; border-radius: 7px; border: 1px solid #30363d;
    background: #1c2128; color: #8b949e; font-size: 12px; cursor: pointer;
  }
  .btn-logout:hover { color: #f85149; border-color: #f85149; }

  main { padding: 24px 28px; }

  .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
  .tab {
    padding: 7px 20px; border-radius: 7px; border: 1px solid #30363d;
    background: #161b22; color: #8b949e; font-size: 13px; font-weight: bold; cursor: pointer;
  }
  .tab.active { background: #2dd4bf; border-color: #2dd4bf; color: #0d1117; }

  .top-bar { display: flex; justify-content: flex-end; margin-bottom: 12px; }
  .btn-new {
    padding: 8px 16px; border-radius: 7px; border: 1px solid #2dd4bf;
    background: rgba(45,212,191,0.1); color: #2dd4bf; font-size: 13px; cursor: pointer;
  }
  .btn-new:hover { background: rgba(45,212,191,0.2); }

  .table-card { background: #161b22; border: 1px solid #30363d; border-radius: 10px; overflow: hidden; }
  .table-head {
    display: grid; grid-template-columns: 60px 1fr 160px;
    padding: 12px 18px; background: #1c2128; border-bottom: 1px solid #30363d;
    font-size: 12px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.05em;
  }
  .table-head .right { text-align: right; }

  .row { border-bottom: 1px solid #30363d; }
  .row:last-child { border-bottom: none; }
  .row-main {
    display: grid; grid-template-columns: 60px 1fr 160px;
    align-items: center; padding: 14px 18px; cursor: pointer;
  }
  .row-main:hover { background: rgba(45,212,191,0.05); }
  .row-num { font-size: 13px; color: #8b949e; }
  .row-aim { display: flex; align-items: center; gap: 8px; font-size: 14px; flex-wrap: wrap; }
  .chevron { font-size: 11px; color: #8b949e; transition: transform 0.2s; display: inline-block; }
  .row.open .chevron { transform: rotate(90deg); color: #2dd4bf; }
  .badge {
    font-size: 11px; padding: 2px 8px; border-radius: 5px;
    background: #1c2128; border: 1px solid #30363d; color: #8b949e; white-space: nowrap;
  }
  .badge.has { background: rgba(45,212,191,0.1); border-color: #2dd4bf; color: #2dd4bf; }

  .row-action { text-align: right; display: flex; gap: 6px; justify-content: flex-end; }
  .btn-sm {
    padding: 5px 11px; border-radius: 6px; border: 1px solid #30363d;
    background: #1c2128; color: #8b949e; font-size: 12px; cursor: pointer; display: none;
  }
  .row:hover .btn-sm { display: inline-block; }
  .btn-sm:hover { color: #2dd4bf; border-color: #2dd4bf; }
  .btn-sm.danger:hover { color: #f85149; border-color: #f85149; }

  .row-content { display: none; padding: 0 18px 14px 60px; }
  .row.open .row-content { display: block; }

  .part-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 10px 12px; background: #1c2128; border: 1px solid #30363d;
    border-radius: 7px; margin-bottom: 8px;
  }
  .part-dot { width: 7px; height: 7px; border-radius: 50%; background: #2dd4bf; margin-top: 5px; flex-shrink: 0; }
  .part-body { flex: 1; min-width: 0; }
  .part-name { font-size: 13px; color: #e6edf3; margin-bottom: 6px; font-weight: 600; }
  .code-wrapper { position: relative; }
  .part-code {
    background: #0d1117; border: 1px solid #30363d; border-radius: 5px;
    padding: 8px 10px; font-family: monospace; font-size: 12px; color: #79c0ff;
    white-space: pre-wrap; word-break: break-all; max-height: 220px; overflow-y: auto;
    padding-right: 75px;
  }
  .btn-copy {
    position: absolute; top: 6px; right: 6px;
    padding: 3px 10px; border-radius: 5px; border: 1px solid #30363d;
    background: #1c2128; color: #8b949e; font-size: 11px; cursor: pointer;
  }
  .btn-copy:hover, .btn-copy.copied { color: #2dd4bf; border-color: #2dd4bf; }
  .part-actions { display: flex; gap: 6px; margin-top: 6px; }
  .btn-part-sm {
    padding: 3px 10px; border-radius: 5px; border: 1px solid #30363d;
    background: transparent; color: #8b949e; font-size: 11px; cursor: pointer;
  }
  .btn-part-sm:hover { color: #2dd4bf; border-color: #2dd4bf; }
  .btn-part-sm.danger:hover { color: #f85149; border-color: #f85149; }

  .empty { padding: 12px; color: #8b949e; font-size: 13px; font-style: italic; }

  /* loading spinner */
  .loading {
    text-align: center; padding: 40px; color: #8b949e; font-size: 14px;
  }
  .spinner {
    display: inline-block; width: 20px; height: 20px;
    border: 2px solid #30363d; border-top-color: #2dd4bf;
    border-radius: 50%; animation: spin 0.7s linear infinite; margin-right: 8px;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-bg {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.75); z-index: 100; align-items: center; justify-content: center;
  }
  .modal-bg.show { display: flex; }
  .modal {
    background: #161b22; border: 1px solid #30363d; border-radius: 10px;
    padding: 24px; width: 520px; max-width: 96vw;
  }
  .modal h3 { font-size: 15px; margin-bottom: 16px; }
  .modal label { font-size: 12px; color: #8b949e; display: block; margin-bottom: 4px; }
  .modal input, .modal textarea {
    width: 100%; padding: 9px 12px; border-radius: 7px;
    border: 1px solid #30363d; background: #0d1117;
    color: #e6edf3; font-size: 13px; margin-bottom: 12px; outline: none;
  }
  .modal input:focus, .modal textarea:focus { border-color: #2dd4bf; }
  .modal textarea { min-height: 150px; resize: vertical; font-family: monospace; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
  .btn-cancel {
    padding: 7px 16px; border-radius: 7px; border: 1px solid #30363d;
    background: #1c2128; color: #8b949e; font-size: 13px; cursor: pointer;
  }
  .btn-save {
    padding: 7px 16px; border-radius: 7px; border: none;
    background: #2dd4bf; color: #0d1117; font-size: 13px; font-weight: bold; cursor: pointer;
  }
  .btn-save:hover { background: #5eead4; }

  /* toast */
  #toast {
    position: fixed; bottom: 28px; right: 28px;
    background: #1c2128; border: 1px solid #2dd4bf; color: #2dd4bf;
    padding: 10px 18px; border-radius: 8px; font-size: 13px;
    opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200;
  }
  #toast.show { opacity: 1; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="logo-icon">üìñ</div>
    <h2>Practical Manager</h2>
    <p>Sign in as admin to edit, or continue as guest.</p>
    <div class="login-error" id="login-error">‚ùå Wrong username or password.</div>
    <input type="text" id="login-user" placeholder="Username" autocomplete="off" />
    <input type="password" id="login-pass" placeholder="Password" />
    <button class="btn-login" onclick="doLogin()">Login as Admin</button>
    <button class="btn-guest" onclick="doGuest()">Continue as Guest (View Only)</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="logo"><span class="logo-icon">üìñ</span> Practical Manager</div>
    <div class="header-right">
      <span class="role-badge" id="role-badge"></span>
      <button class="btn-logout" onclick="doLogout()">Logout</button>
    </div>
  </header>
  <main>
    <div class="tabs" id="tabs"></div>
    <div class="top-bar" id="top-bar" style="display:none">
      <button class="btn-new" onclick="openAddPractical()">+ New Practical</button>
    </div>
    <div class="table-card">
      <div class="table-head">
        <span>Sr.</span><span>Aim</span><span class="right">Actions</span>
      </div>
      <div id="list"></div>
    </div>
  </main>
</div>

<!-- Modal -->
<div class="modal-bg" id="modal">
  <div class="modal">
    <h3 id="modal-title">Add Part</h3>
    <label id="label-name">Title</label>
    <input type="text" id="modal-name" />
    <label id="label-code">Code / Notes</label>
    <textarea id="modal-code"></textarea>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveModal()">Save</button>
    </div>
  </div>
</div>

<div id="toast">‚úÖ Copied!</div>

<script>
  // ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
  const SUPABASE_URL = 'https://kbrgauefaweedxqbjlpc.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImticmdhdWVmYXdlZWR4cWJqbHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNzU0ODYsImV4cCI6MjA4Nzc1MTQ4Nn0.aVgB2zhQGLa3lf4qAwCQEUtvmufVhqvxyznyB4Lje6M';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
  const ADMIN_USER = 'admin';
  const ADMIN_PASS = 'practical123';
  let isAdmin = false;
  let currentTab = 'JAVA';
  const TABS = ['JAVA', 'ADS', 'OS'];

  // local cache of practicals from Supabase
  let practicals = [];

  document.getElementById('login-pass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

  function doLogin() {
    const u = document.getElementById('login-user').value.trim();
    const p = document.getElementById('login-pass').value;
    if (u === ADMIN_USER && p === ADMIN_PASS) {
      isAdmin = true;
      document.getElementById('login-error').style.display = 'none';
      startApp();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  }

  function doGuest() { isAdmin = false; startApp(); }

  function doLogout() {
    isAdmin = false;
    document.getElementById('app').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('login-user').value = '';
    document.getElementById('login-pass').value = '';
  }

  function startApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('role-badge').textContent = isAdmin ? 'üîë Admin' : 'üëÅ Guest';
    document.getElementById('role-badge').className = 'role-badge ' + (isAdmin ? 'admin' : 'guest');
    document.getElementById('top-bar').style.display = isAdmin ? 'flex' : 'none';
    renderTabs();
    loadPracticals();
  }

  // ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
  function renderTabs() {
    document.getElementById('tabs').innerHTML = TABS.map(t =>
      `<button class="tab ${t === currentTab ? 'active' : ''}" onclick="setTab('${t}')">${t}</button>`
    ).join('');
  }
  function setTab(t) { currentTab = t; renderTabs(); renderList(); }

  // ‚îÄ‚îÄ SUPABASE CRUD ‚îÄ‚îÄ
  async function loadPracticals() {
    document.getElementById('list').innerHTML = `<div class="loading"><span class="spinner"></span>Loading from database...</div>`;
    const { data, error } = await sb.from('practicals').select('*').order('id', { ascending: true });
    if (error) {
      document.getElementById('list').innerHTML = `<div class="empty" style="padding:20px;color:#f85149;">‚ùå Error: ${error.message}</div>`;
      return;
    }
    // parse parts JSON string back to array
    practicals = (data || []).map(row => ({
      ...row,
      parts: row.parts ? JSON.parse(row.parts) : []
    }));
    renderList();
  }

  async function dbInsert(subject, aim) {
    const { data, error } = await sb.from('practicals').insert([{ subject, aim, parts: '[]' }]).select();
    if (error) { alert('Error saving: ' + error.message); return null; }
    return data[0];
  }

  async function dbUpdate(id, parts) {
    const { error } = await sb.from('practicals').update({ parts: JSON.stringify(parts) }).eq('id', id);
    if (error) { alert('Error updating: ' + error.message); }
  }

  async function dbDelete(id) {
    const { error } = await sb.from('practicals').delete().eq('id', id);
    if (error) { alert('Error deleting: ' + error.message); }
  }

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function renderList() {
    const list = document.getElementById('list');
    const filtered = practicals.filter(p => p.subject === currentTab);

    if (!filtered.length) {
      list.innerHTML = `<div class="empty" style="padding:20px;">${isAdmin ? 'No practicals yet. Click "+ New Practical" to add.' : 'No practicals yet.'}</div>`;
      return;
    }

    list.innerHTML = filtered.map((p, i) => `
      <div class="row" id="row-${p.id}">
        <div class="row-main" onclick="toggleRow('${p.id}')">
          <span class="row-num">${i + 1}</span>
          <div class="row-aim">
            <span class="chevron">‚ñ∂</span>
            <span>${escHtml(p.aim)}</span>
            <span class="badge ${p.parts.length ? 'has' : ''}">${p.parts.length} parts</span>
          </div>
          <div class="row-action">
            ${isAdmin ? `
              <button class="btn-sm" onclick="event.stopPropagation(); openAddPart('${p.id}')">+ Part</button>
              <button class="btn-sm danger" onclick="event.stopPropagation(); deletePractical('${p.id}')">‚úï</button>
            ` : ''}
          </div>
        </div>
        <div class="row-content">
          ${p.parts.length === 0
            ? `<div class="empty">${isAdmin ? 'No parts yet ‚Äî click "+ Part" to add code.' : 'No parts added yet.'}</div>`
            : p.parts.map((pt, j) => `
                <div class="part-item">
                  <div class="part-dot"></div>
                  <div class="part-body">
                    <div class="part-name">${escHtml(pt.name)}</div>
                    ${pt.code ? `
                      <div class="code-wrapper">
                        <div class="part-code">${escHtml(pt.code)}</div>
                        <button class="btn-copy" onclick="copyCode('${p.id}',${j},this)">üìã Copy</button>
                      </div>` : ''
                    }
                    ${isAdmin ? `
                      <div class="part-actions">
                        <button class="btn-part-sm" onclick="openEditPart('${p.id}',${j})">‚úè Edit</button>
                        <button class="btn-part-sm danger" onclick="deletePart('${p.id}',${j})">‚úï Delete</button>
                      </div>` : ''
                    }
                  </div>
                </div>`).join('')
          }
        </div>
      </div>
    `).join('');
  }

  function toggleRow(id) { document.getElementById(`row-${id}`).classList.toggle('open'); }

  // ‚îÄ‚îÄ COPY ‚îÄ‚îÄ
  function copyCode(id, j, btn) {
    const p = practicals.find(x => String(x.id) === String(id));
    if (!p) return;
    navigator.clipboard.writeText(p.parts[j].code).then(() => {
      btn.textContent = '‚úÖ Copied'; btn.classList.add('copied');
      showToast('‚úÖ Copied to clipboard!');
      setTimeout(() => { btn.textContent = 'üìã Copy'; btn.classList.remove('copied'); }, 2000);
    });
  }

  function showToast(msg = '‚úÖ Done!') {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }

  // ‚îÄ‚îÄ MODAL STATE ‚îÄ‚îÄ
  let modalMode = null, modalTargetId = null, modalPartIdx = null;

  function openAddPractical() {
    modalMode = 'practical'; modalTargetId = null; modalPartIdx = null;
    document.getElementById('modal-title').textContent = 'Add New Practical';
    document.getElementById('label-name').textContent = 'Practical Aim / Title';
    document.getElementById('label-code').textContent = 'Description (optional)';
    document.getElementById('modal-name').placeholder = 'e.g. Practical No 09 ...';
    document.getElementById('modal-code').placeholder = 'Optional description...';
    document.getElementById('modal-name').value = '';
    document.getElementById('modal-code').value = '';
    document.getElementById('modal').classList.add('show');
  }

  function openAddPart(id) {
    modalMode = 'addPart'; modalTargetId = id; modalPartIdx = null;
    document.getElementById('modal-title').textContent = 'Add Part';
    document.getElementById('label-name').textContent = 'Part Title';
    document.getElementById('label-code').textContent = 'Code / Notes';
    document.getElementById('modal-name').placeholder = 'e.g. Part A';
    document.getElementById('modal-code').placeholder = 'Paste your code here...';
    document.getElementById('modal-name').value = '';
    document.getElementById('modal-code').value = '';
    document.getElementById('modal').classList.add('show');
  }

  function openEditPart(id, j) {
    modalMode = 'editPart'; modalTargetId = id; modalPartIdx = j;
    const p = practicals.find(x => String(x.id) === String(id));
    document.getElementById('modal-title').textContent = 'Edit Part';
    document.getElementById('label-name').textContent = 'Part Title';
    document.getElementById('label-code').textContent = 'Code / Notes';
    document.getElementById('modal-name').value = p.parts[j].name;
    document.getElementById('modal-code').value = p.parts[j].code || '';
    document.getElementById('modal').classList.add('show');
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('show');
    modalMode = null; modalTargetId = null; modalPartIdx = null;
  }

  async function saveModal() {
    const name = document.getElementById('modal-name').value.trim();
    const code = document.getElementById('modal-code').value.trim();
    if (!name) { alert('Please enter a title.'); return; }

    document.querySelector('.btn-save').textContent = 'Saving...';

    if (modalMode === 'practical') {
      const row = await dbInsert(currentTab, name);
      if (row) practicals.push({ ...row, parts: [] });

    } else if (modalMode === 'addPart') {
      const p = practicals.find(x => String(x.id) === String(modalTargetId));
      p.parts.push({ name, code });
      await dbUpdate(p.id, p.parts);

    } else if (modalMode === 'editPart') {
      const p = practicals.find(x => String(x.id) === String(modalTargetId));
      p.parts[modalPartIdx] = { name, code };
      await dbUpdate(p.id, p.parts);
    }

    document.querySelector('.btn-save').textContent = 'Save';
    const savedId = modalTargetId;
    closeModal();
    renderList();
    if (savedId) setTimeout(() => {
      const row = document.getElementById(`row-${savedId}`);
      if (row && !row.classList.contains('open')) row.classList.add('open');
    }, 50);
    showToast('‚úÖ Saved to database!');
  }

  async function deletePractical(id) {
    if (!confirm('Delete this practical and all its parts?')) return;
    await dbDelete(id);
    practicals = practicals.filter(x => String(x.id) !== String(id));
    renderList();
    showToast('üóë Deleted!');
  }

  async function deletePart(id, j) {
    if (!confirm('Delete this part?')) return;
    const p = practicals.find(x => String(x.id) === String(id));
    p.parts.splice(j, 1);
    await dbUpdate(p.id, p.parts);
    renderList();
    setTimeout(() => {
      const row = document.getElementById(`row-${id}`);
      if (row) row.classList.add('open');
    }, 50);
    showToast('üóë Deleted!');
  }

  document.getElementById('modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
</script>
</body>
</html>
